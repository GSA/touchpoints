<div class="well">
  <h1>
    Viewing a Service
  </h1>
  <div class="well">
    <p>
      <strong>Organization:</strong>
      <% if is_at_least_service_manager?(user: current_user, service: @service) %>
      <%= @service.organization ? link_to(@service.organization.name, admin_organization_path(@service.organization)) : nil %>
      <% else %>
      <%= @service.organization.name %>
      <% end %>
    </p>
    <p>
      <strong>Service Name:</strong>
      <%= @service.name %>
    </p>
    <p>
      <strong>Description:</strong>
      <%= @service.description || "<i>no description provided</i>".html_safe %>
    </p>
    <p>
      <strong>
        <span title="High Impact Service Provider">HISP</span>
        Service?
      </strong>
      <%= @service.hisp %>
    </p>
  </div>
  <%= link_to 'Edit', edit_admin_service_path(@service), class: "usa-button" %>

  <div class="well">
    <div class="roles-and-permissions">
      <h2>
        Roles & Permissions for this Service
      </h2>
      <p>
        Assign permissions for others Users in your Organization.
        Permission levels include: 1) Service Manager or 2) Submission Viewer.
      </p>
      <div>
        <% if @service.users.present? %>
        <table class="usa-table">
          <thead>
            <tr>
              <th>
                Role
              </th>
              <th>
                Email
              </th>
              <th>
              </th>
            </tr>
          </thead>
          <tbody>
            <% @service.users.each do |user| %>
            <tr data-user-id="<%= user.id %>">
              <td>
                <% friendly_roles = {
                  "service_manager" => "Service Manager",
                  "submission_viewer" => "Submission Viewer"
                }
                %>
                <%= friendly_roles[@service.user_role?(user: user)] %>
              </td>
              <td>
                <%= user.email %>
              </td>
              <td>
                <% if user != current_user && is_at_least_service_manager?(user: current_user, service: @service) %>
                <a href="#" class="remove-user" data-id="<%= user.id %>">
                  Remove
                </a>
                <% end %>
              </td>
            </tr>
            <% end %>
          </tbody>
        </table>
        <% else %>
        <div class="usa-alert usa-alert--info" >
          <div class="usa-alert__body">
            <p class="usa-alert__text">
              No users at this time
            </p>
          </div>
        </div>
        <% end %>

        <% if flash && ["User successfully added", "User successfully removed"].include?(flash.notice) %>
        <%= render 'components/flash', flash: flash %>
        <% end %>

        <% if is_at_least_service_manager?(user: current_user, service: @service) %>
        <div class="well">
          <% if @available_members.present? %>
          <%= select_tag :add_user_id, options_for_select(@available_members.map { |user| [user.email, user.id] }), prompt: "Add a Service Manager?", id: "add-user-dropdown", style: "display: inline-block; margin-right: 1em;", class: "usa-select" %>
          <!-- <span class="usa-buton" name="button" id="add-user-button">Add User</span> -->
          <button type="button" class="usa-button" name="button" id="add-user-button">Add Service Manager</button>
          <% else %>
          <div class="usa-alert usa-alert--info">
            <div class="usa-alert__body">
              <p class="usa-alert__text">
                All Users have been added. No Service Managers to add.
              </p>
            </div>
          </div>
          <% end %>
        </div>

        <div class="well">
          <% if @available_members.present? %>
          <%= select_tag :add_user_id, options_for_select(@available_members.map { |user| [user.email, user.id] }), prompt: "Add a Submission Viewer?", id: "add-submission-viewer-dropdown", style: "display: inline-block; margin-right: 1em;", class: "usa-select" %>
          <button type="button" class="usa-button" name="button" id="add-submission-viewer-button">Add Submission Viewer</button>
          <% else %>
          <div class="usa-alert usa-alert--info">
            <div class="usa-alert__body">
              <p class="usa-alert__text">
                All Users have been added. No Submission Viewers to add.
              </p>
            </div>
          </div>
          <% end %>
        </div>
        <% end %>
      </div>
    </div>
  </div>

  <% if is_at_least_service_manager?(user: current_user, service: @service) %>
    <div class="well">
      <h2>
        Touchpoints for this Service
      </h2>
      <% if @service.touchpoints.present? %>
        <ul class="usa-list">
          <% @service.touchpoints.each do |touchpoint| %>
          <li>
            <%= link_to touchpoint.name, admin_touchpoint_path(touchpoint) %>
          </li>
          <% end %>
        </ul>
      <% else %>
      <div class="usa-alert usa-alert--info">
        <div class="usa-alert__body">
          <p class="usa-alert__text">
            No Touchpoints are assigned to this Service.
          </p>
        </div>
      </div>
      <div class="usa-alert">
        Now that you have a Service
        <%= link_to("add a Touchpoint", new_admin_touchpoint_path) %>
      </div>
      <% end %>
    </div>
  <% end %>
</div>

<script type="text/javascript">
  $(function() {
    // Initially set to disabled
    $("#add-user-button").attr("disabled", true);
    $("#add-submission-viewer-button").attr("disabled", true);

    $("#add-user-button").on("click", function(e) {
      var userId = $("#add-user-dropdown").val();

      var request = $.ajax({
        url: "/admin/services/<%= @service.id %>/add_user",
        dataType: "json",
        method: "POST",
        data: {
          user_id : userId,
          role: "service_manager"
        }
      }).done(function(response) {
        location.reload();
      }).fail(function(response) {
        alert(response);
      });
    });

    $("#add-submission-viewer-button").on("click", function(e) {
      var userId = $("#add-submission-viewer-dropdown").val();

      var request = $.ajax({
        url: "/admin/services/<%= @service.id %>/add_user",
        dataType: "json",
        method: "POST",
        data: {
          user_id : userId,
          role: "submission_viewer"
        }
      }).done(function(response) {
        location.reload();
      }).fail(function(response) {
        alert(response);
      });
    });

    $("#add-user-dropdown").on("change", function(e) {
      var userId = e.target.value
      if (userId != "") {
        $("#add-user-button").attr("disabled", false);
      } else {
        $("#add-user-button").attr("disabled", true);
      }
    });

    $("#add-submission-viewer-dropdown").on("change", function(e) {
      var userId = e.target.value
      if (userId != "") {
        $("#add-submission-viewer-button").attr("disabled", false);
      } else {
        $("#add-submission-viewer-button").attr("disabled", true);
      }
    });

    // Remove a Service Manager or Submission Viewer User
    $(".remove-user").on("click", function(e) {
      var userId = $(this).attr("data-id");

      var request = $.ajax({
        url: "/admin/services/<%= @service.id %>/remove_user",
        dataType: "json",
        method: "POST",
        data: { user_id : userId }
      }).done(function(response) {
        location.reload();
      }).fail(function(response) {
        alert(response);
      });
    });
  });
</script>
