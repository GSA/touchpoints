#!/usr/bin/env bash
set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

echo "-----> Rust Buildpack: Supplying Rust"
echo "Build Dir: $BUILD_DIR"
ls -la "$BUILD_DIR"

RUST_DIR="$DEPS_DIR/rust"
mkdir -p "$RUST_DIR"

export RUSTUP_HOME="$RUST_DIR/rustup"
export CARGO_HOME="$RUST_DIR/cargo"

# Install Rust
# We use the minimal profile to save space and time
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path --profile minimal

# Verify installation
export PATH="$CARGO_HOME/bin:$PATH"
if ! command -v rustc >/dev/null; then
    echo "Rust installation failed"
    exit 1
fi

echo "Rust version: $(rustc --version)"
echo "Cargo version: $(cargo --version)"

# Make available to subsequent buildpacks
mkdir -p "$DEPS_DIR/env"
echo -n "$CARGO_HOME/bin" > "$DEPS_DIR/env/PATH"
echo -n "$RUSTUP_HOME" > "$DEPS_DIR/env/RUSTUP_HOME"
echo -n "$CARGO_HOME" > "$DEPS_DIR/env/CARGO_HOME"

# Make available at runtime
mkdir -p "$DEPS_DIR/profile.d"
cat <<EOF > "$DEPS_DIR/profile.d/rust.sh"
export RUSTUP_HOME="$RUST_DIR/rustup"
export CARGO_HOME="$RUST_DIR/cargo"
export PATH="$CARGO_HOME/bin:\$PATH"
EOF

# Explicitly build the Rust extension if it exists
if [ -d "$BUILD_DIR/ext/widget_renderer" ]; then
    echo "-----> Building Rust extension in ext/widget_renderer"
    pushd "$BUILD_DIR/ext/widget_renderer"
    cargo build --release
    popd
else
    echo "-----> ext/widget_renderer not found in $BUILD_DIR"
    ls -R "$BUILD_DIR"
fi
